<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ExploraU - Del mapa directo a tus sue√±os</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
/* Estilos esenciales - Dise√±o Beta */
body { 
    font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    margin:0; 
    padding:0; 
    color:#333; 
    display:flex; 
    flex-direction:column; 
    min-height:100vh; 
    background: linear-gradient(135deg, #e0f7fa, #ffffff);
}
header {
    background: #003366; 
    color: white; 
    padding: 30px 25px; 
    box-shadow:0 8px 25px rgba(0,0,0,0.15); 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    z-index: 10; 
}

#map {
    /* Esto ya est√° en tu c√≥digo y es la soluci√≥n: */
    flex-grow: 1; 
    
    /* ‚úÖ Esto es lo que necesitas para que ocupe todo el espacio libre 
       dentro del .content-wrapper: */
    height: 100%; 
    width: 100%;
    
    /* Opcional: Para asegurar que el mapa tiene una altura m√≠nima */
    min-height: 400px;
    
    /* Estilos est√©ticos de tu c√≥digo que ya est√°n bien: */
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 0; /* Importante que no interfiera con otros elementos */
}

#details-panel {
    position: fixed; 
    top: 0;
    right: 0;
    width: 350px;
    height: 100%;
    background-color: white;
    box-shadow: -6px 0 20px rgba(0, 0, 0, 0.3); 
    transform: translateX(350px); 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
    z-index: 2000; 
    border-left: 3px solid #007bff; 
}
#details-panel.open {
    transform: translateX(0); 
} 

/* Estilos del Logo y Header */
.app-logo { height: 150px !important; width: auto !important; display: block; }
.logo-container { min-width: 160px; padding-right: 30px; font-size: 0; }
.header-content { flex-grow: 1; text-align: center; }
.header-content h1 { font-size: 2.2em; margin: 0; font-weight: 700; }
.header-content p { font-size: 1.1em; margin: 0; font-weight: 400; opacity: 0.9; }

/* Estilos para el Asistente de Voz */
#voice-btn {
    width: auto; 
    padding: 8px 15px; 
    margin: 0; 
    font-size: 0.9em;
    font-weight: 600;
    border-radius: 4px;
    transition: background-color 0.2s;
}
.voice-container { 
    min-width: 150px; 
    text-align: right; 
    padding-left: 20px; 
}

@media (max-width: 768px) {
    .app-logo { height: 100px !important; }
    .logo-container { min-width: 110px; padding-right: 15px; }
    header { padding: 20px 10px; }
    .header-content h1 { font-size: 1.6em; }
    .header-content p { font-size: 0.9em; }
    #map { height: 60vh; }
    #details-panel { width: 100%; }
    #details-panel.open { transform: translateX(0); }
}

.close-btn {
    position: sticky; top: 0; left: 100%; margin-left: -35px; font-size: 28px; width: 35px; 
    height: 35px; line-height: 35px; text-align: center; color: #003366; background: #e9ecef; 
    border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.15); cursor: pointer; border: none;
    transition: all 0.2s ease; z-index: 2001; font-weight: 300;
}
.close-btn:hover { background-color: #007bff; color: white; transform: scale(1.05); }

textarea {
    width: 100%; padding: 10px; margin-top: 10px; box-sizing: border-box; border-radius: 6px;
    border: 1px solid #ccc; resize: vertical; font-size: 1em;
}
button {
    width: 100%; background-color: #007bff; color: white; padding: 10px; cursor: pointer;
    border: none; border-radius: 6px; font-weight: 600; transition: background-color 0.2s, transform 0.1s;
    margin-top: 15px;
}
button:hover { background-color: #0056b3; transform: translateY(-1px); }

#uni-details-content h2, #uni-details-content h3, #uni-details-content h4 {
    color: #003366; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; margin-top: 25px;
}

.review-card {
    border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 10px;
    background-color: #fafafa; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.review-card p { margin: 3px 0; }
.review-card p:first-child { font-weight: 600; color: #333; }
.review-card small { display: block; margin-top: 5px; color: #999; font-size: 0.8em; }

.info-text { font-size: 1em; color: #007bff; font-weight: 600; }
main {
    display: flex; /* Convierte main en un contenedor flexbox para su contenido */
    flex-grow: 1; /* ‚úÖ CLAVE: Permite que main ocupe el espacio restante en el body */
    overflow: hidden; /* Evita desbordamientos y barras de desplazamiento innecesarias */
    padding: 20px; /* A√±ade un poco de margen alrededor del mapa */
}
</style>
</head>
<body>

<header>
    <div class="logo-container">
        <img src="fotos/logo.png" class="app-logo" alt="ExploraU Logo">
    </div>
    
    <div class="header-content">
        <h1>ExploraU üéì</h1>
        <p>Tu gu√≠a educativa: del mapa directo a tus sue√±os</p>
    </div>

    <div class="voice-container">
        <button id="voice-btn" onclick="toggleVoiceAssistant()" 
                style="background-color: #28a745;">
            üé§ Activar Asistente
        </button>
        <p id="voice-status" style="color: white; font-size: 0.85em; margin-top: 5px; opacity: 0.8;">Inactivo</p>
    </div>
</header>

<main>
    <div id="map"></div>
</main>

<div id="details-panel">
    <button class="close-btn" onclick="closeDetailsPanel()">√ó</button> 
    <h2>Detalles de la Universidad</h2>
    <div id="uni-details-content">
        <p style="text-align: center; padding: 50px 0; color: #888;">Haz clic en un marcador para ver sus detalles y contribuir con rese√±as.</p>
    </div>
</div>

<script>
let universities = []; 
let currentUniversity = null; 

// --- Configuraci√≥n de Voz ---
const VOICE_COMMAND = 'ok explorau';
let recognition = null;
let isListening = false;
const synth = window.speechSynthesis;

// 1. Inicializaci√≥n de Leaflet
const map = L.map('map').setView([-36.78470994968031, -73.08512763287513], 1); 

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

const markers = L.markerClusterGroup({ spiderfyOnMaxZoom: false });
map.addLayer(markers);

// FUNCIONES DE PERSISTENCIA 
function loadReviews() {
    const savedReviews = localStorage.getItem('universityReviews');
    if (savedReviews) {
        try {
            const reviewsMap = JSON.parse(savedReviews);
            
            universities.forEach(uni => {
                if (reviewsMap[uni.id]) {
                    uni.reviews = reviewsMap[uni.id].map(r => ({
                        ...r,
                        status: r.status || 'approved' 
                    }));
                }
            });
        } catch (e) {
            console.error("Error al parsear rese√±as de localStorage:", e);
        }
    }
}

function saveReviews() {
    const reviewsToSave = {};
    
    universities.forEach(uni => {
        if (uni.reviews && uni.reviews.length > 0) {
            // Solo guardamos las rese√±as con la estructura completa, no solo el contenido
            reviewsToSave[uni.id] = uni.reviews;
        }
    });
    
    localStorage.setItem('universityReviews', JSON.stringify(reviewsToSave));
}

function getRandomPaesScore(min, max) {
    return 'Referencial: ' + (Math.floor(Math.random() * (max - min + 1)) + min);
}

// 2. Funci√≥n de carga de datos (GeoJSON local)
async function fetchUniversities() {
    try {
        const resp = await fetch('export.geojson');
        
        if (!resp.ok) {
            throw new Error(`HTTP error! status: ${resp.status}`);
        }
        
        const geojsonData = await resp.json();

        geojsonData.features.forEach(feature => {
            const properties = feature.properties;
            const geometry = feature.geometry;
            let lat, lng;

            if (!properties || properties.amenity !== 'university') {
                return;
            }

            if (geometry && geometry.type === 'Point' && geometry.coordinates) {
                [lng, lat] = geometry.coordinates; 
            } else {
                return;
            }
            
            const uni = {
                id: properties['@id'], 
                name: properties.name || 'Sin nombre',
                city: properties['addr:city'] || properties['addr:place'] || properties['is_in:city'] || properties['is_in:district'] || properties['is_in'] || 'Ciudad no especificada',
                lat: lat, 
                lng: lng, 
                reviews: [],
                paes: getRandomPaesScore(500,980), 
                website: properties['website'] || '' 
            };
            
            universities.push(uni);

            const marker = L.marker([lat, lng]).addTo(markers);
            marker.bindPopup(`<strong>${uni.name}</strong><br>${uni.city}`);
            marker.on('click', () => showUniversityDetails(uni));
        });

        loadReviews(); 

        if (markers.getLayers().length > 0) {
            map.fitBounds(markers.getBounds());
        } else {
            map.setView([-33.447487, -70.673676], 5); 
        }

    } catch (error) {
        console.error('Error al cargar o procesar el archivo GeoJSON:', error);
    }
}


// 3. Funciones de Interfaz y Rese√±as
function showUniversityDetails(uni) {
    currentUniversity = uni;
    const panel = document.getElementById('details-panel');
    const content = document.getElementById('uni-details-content');
    
    // CLAVE: SOLO mostrar rese√±as aprobadas
    const approvedReviews = uni.reviews.filter(r => r.status === 'approved');
    
    let reviewHtml = approvedReviews.length > 0 
        ? approvedReviews.map(r => `
            <div class="review-card">
                <p><strong>Usuario:</strong> ${r.user}</p>
                <p style="font-style: italic;">"${r.text}"</p>
                <small>Fecha: ${new Date(r.timestamp).toLocaleDateString()}</small>
            </div>
        `).join('')
        : '<p style="text-align: center; color: #666;">S√© el primero en dejar una rese√±a (ser√° revisada antes de publicarse).</p>';

    content.innerHTML = `
        <h3>${uni.name}</h3>
        <p><strong>ID OpenStreetMap:</strong> ${uni.id}</p>
        <p><strong>Ciudad:</strong> ${uni.city}</p>
        <hr>

        <h4>Informaci√≥n Acad√©mica y Web:</h4>
        <p class="info-text"><strong>Puntaje PAES:</strong> ${uni.paes || 'No especificado'}</p>
        <p class="info-text"><strong>Sitio Web:</strong> ${uni.website ? `<a href="${uni.website}" target="_blank">${uni.website}</a>` : 'No especificado'}</p>
        <hr>

        <h4>Dejar una Rese√±a:</h4>
        <textarea id="review-text" rows="4" placeholder="Comparte tu experiencia. (Tu rese√±a estar√° PENDIENTE de aprobaci√≥n)"></textarea>
        <button onclick="submitReview()">Enviar Rese√±a</button>
        <hr>
        
        <h4>Rese√±as de la Comunidad (${approvedReviews.length} publicadas):</h4>
        ${reviewHtml}
    `;
    
    panel.classList.add('open'); 
    map.panTo([uni.lat, uni.lng]).setZoom(12);
}

function closeDetailsPanel() {
    document.getElementById('details-panel').classList.remove('open');
    currentUniversity = null;
}

function submitReview() {
    if (!currentUniversity) return;

    const reviewText = document.getElementById('review-text').value.trim();
    if (reviewText) {
        currentUniversity.reviews.push({ 
            user: 'Usuario An√≥nimo', 
            text: reviewText,
            timestamp: new Date().toISOString(),
            status: 'pending' // CLAVE: La nueva rese√±a es PENDIENTE
        });
        
        saveReviews(); 
        
        alert('¬°Rese√±a enviada con √©xito! Quedar√° PENDIENTE de aprobaci√≥n en el panel del desarrollador.');
        document.getElementById('review-text').value = '';
        showUniversityDetails(currentUniversity); // Recargar
    } else {
        alert('Por favor, escribe una rese√±a antes de enviarla.');
    }
}

// 4. Funciones del Asistente de Voz

function speak(text) {
    // Detiene cualquier voz anterior
    synth.cancel(); 
    
    const utterThis = new SpeechSynthesisUtterance(text);
    
    // Configura la voz (opcional)
    const voices = synth.getVoices();
    const spanishVoice = voices.find(voice => voice.lang.startsWith('es-'));
    if (spanishVoice) {
        utterThis.voice = spanishVoice;
    }
    
    // Inicia la s√≠ntesis
    synth.speak(utterThis);
}

/** üì¢ FUNCI√ìN PRINCIPAL DE RECONOCIMIENTO DE VOZ */
function initializeRecognition() {
   const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
    speak("Lo siento, tu navegador no soporta el reconocimiento de voz. Usa Chrome o Edge para la mejor experiencia.");
    document.getElementById('voice-status').textContent = 'Error: Navegador no compatible.';
    return;
}
    recognition = new SpeechRecognition();
    recognition.continuous = true; // Escuchar continuamente
    recognition.interimResults = false; // Solo resultados finales
    recognition.lang = 'es-ES'; // Idioma espa√±ol

    recognition.onstart = () => {
        isListening = true;
        document.getElementById('voice-status').textContent = 'Escuchando comando...';
        document.getElementById('voice-btn').style.backgroundColor = '#ffc107'; // Amarillo
        document.getElementById('voice-btn').textContent = 'Escuchando...';
    };

    recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
        
        if (transcript.includes(VOICE_COMMAND)) {
            handleVoiceCommand(transcript);
        }
    };

    recognition.onerror = (event) => {
        console.error('Error de reconocimiento de voz:', event.error);
        if (event.error !== 'no-speech') {
            document.getElementById('voice-status').textContent = 'Error de micr√≥fono. Reinicia.';
        }
        // Reiniciar la escucha si es un error temporal y el modo est√° activo
        if (isListening) {
             setTimeout(() => {
                if(isListening && recognition) {
                    try { recognition.start(); } catch (e) {}
                }
             }, 500); 
        }
    };
    
    recognition.onend = () => {
        // Reiniciar la escucha si el modo sigue activo
        if (isListening) {
            try { recognition.start(); } catch (e) {}
        } else {
            document.getElementById('voice-status').textContent = 'Inactivo';
            document.getElementById('voice-btn').style.backgroundColor = '#28a745'; // Verde
            document.getElementById('voice-btn').textContent = 'üé§ Activar Asistente';
        }
    };
}

/** Maneja el comando "Ok ExploraU" y distribuye la acci√≥n */
function handleVoiceCommand(transcript) {
    
    const cleanTranscript = transcript.toLowerCase().trim();
    const cleanCommand = VOICE_COMMAND.toLowerCase().trim();
    
    // **‚úÖ MEJORA 1: FEEDBACK VISUAL INMEDIATO**
    document.getElementById('voice-status').textContent = `Comando: "${cleanTranscript}". Procesando...`;

    // Si la transcripci√≥n no incluye el comando, ignorar (esto es una doble verificaci√≥n)
    if (!cleanTranscript.includes(cleanCommand)) {
        document.getElementById('voice-status').textContent = 'Comando no detectado (escuchando...)';
        return; 
    }
    
    // Extrae la parte que viene despu√©s de "ok explorau"
    const commandPart = cleanTranscript.substring(cleanTranscript.indexOf(cleanCommand) + cleanCommand.length).trim();

    // **‚úÖ MEJORA 2: FEEDBACK VISUAL DEL COMANDO PARCIAL**
    console.log("Comando extra√≠do:", commandPart);
    
    // L√≥gica 1: Solicitar universidad m√°s cercana
    // Usa expresiones regulares m√°s flexibles (m[√°a]s maneja 'm√°s' y 'mas')
    const nearestMatch = commandPart.match(/dime la universidad m[√°a]s cerca de (.+)/i) || 
                         commandPart.match(/m[√°a]s cerca de (.+)/i);
                         
    if (nearestMatch && nearestMatch[1]) {
        const cityName = nearestMatch[1].trim();
        
        // Si hay un error, el c√≥digo no est√° cargado.
        if (typeof findNearestUniversity !== 'function') {
             speak(`Lo siento, la funci√≥n de b√∫squeda por proximidad no est√° cargada. Buscaste cerca de ${cityName}.`);
             return;
        }

        // Llama a la funci√≥n de b√∫squeda
        findNearestUniversity(cityName);
        return;
    }

    // L√≥gica 2: Detalles de la universidad actualmente seleccionada (L√≥gica por defecto)
    if (!currentUniversity) {
        speak("No hay una universidad seleccionada. Por favor, haz clic en un marcador, o di, Ok ExploraU, dime la universidad m√°s cerca de una ciudad.");
        return;
    }
    
    // Si el usuario solo dice "Ok ExploraU" sin una pregunta
    if (commandPart === "" || commandPart.includes("detalles")) { 
        let details = `Est√°s viendo los detalles de ${currentUniversity.name}. `;
        details += `Est√° ubicada en ${currentUniversity.city}. `;
        details += `Su puntaje PAES referencial es ${currentUniversity.paes}. `;
        
        const approvedReviews = currentUniversity.reviews.filter(r => r.status === 'approved');
        if (approvedReviews.length > 0) {
            details += `Tiene ${approvedReviews.length} rese√±as publicadas. La primera rese√±a dice: ${approvedReviews[0].text.substring(0, 50)}...`;
        } else {
            details += `Actualmente no tiene rese√±as publicadas.`;
        }
        
        speak(details);
        return;
    }
    
    // Si dice "Ok ExploraU [algo que no entendemos]"
    speak(`Lo siento, no entend√≠ el comando: ${commandPart}. Intenta decir: dime la universidad m√°s cerca de...`);
    document.getElementById('voice-status').textContent = 'Comando no v√°lido. Intenta de nuevo.';
} 

/** üîÑ Alterna el estado del asistente de voz */
function toggleVoiceAssistant() {
    if (!recognition) {
        // La inicializaci√≥n incluye la verificaci√≥n de compatibilidad de API
        initializeRecognition();
        if (!recognition) return;
    }

    if (isListening) {
        // DETENER
        isListening = false;
        synth.cancel(); 
        try {
            recognition.stop();
        } catch (e) {
            console.warn("Error al intentar detener el reconocimiento:", e);
        }
        speak("Asistente de ExploraU desactivado.");
    } else {
        // INICIAR
        isListening = true;
        try {
            recognition.start();
            document.getElementById('voice-btn').style.backgroundColor = '#ffc107'; // Amarillo
            document.getElementById('voice-btn').textContent = 'Escuchando...';
            speak("Asistente de ExploraU activado. Di ok ExploraU para escuchar los detalles o buscar por proximidad.");
        } catch (e) {
            // Este es el error m√°s com√∫n: AbortError si ya estaba escuchando o NotAllowedError
            console.error("Error al iniciar el reconocimiento (o ya est√° activo):", e);
            document.getElementById('voice-status').textContent = '‚ö†Ô∏è Fallo al iniciar el micr√≥fono.';
            isListening = false; 
            
            // Si el error es diferente a un "AbortError" (ya escuchando), notificamos al usuario.
            if (e.name !== "AbortError") {
                 speak("Hubo un error al intentar acceder al micr√≥fono. Revisa la consola.");
            }
        }
    }
}



// 5. Iniciar la carga de datos
fetchUniversities();
</script>

<footer>
    <p>&copy; 2025 ExploraU Team. Todos los derechos reservados.</p>
    <p>Hecho con ‚ù§Ô∏è para la exploraci√≥n educativa. | Panel Dev: <a href="dev_panel.html" target="_blank" style="color:red; text-decoration:none;">üîí</a></p>
</footer>

</body>
</html>